{% extends "base.html" %}
{% block title %}Chat – DashMessaging{% endblock %}
{% block nav %}
<nav class="nav-extended primary">
    <div class="nav-wrapper">
        <a href="/" class="brand-logo">DashMessaging</a>
        <ul class="right">
            <li><a href="/">Projects</a></li>
        </ul>
    </div>
    <div class="nav-content">
        <span class="nav-title">{{ project_name or 'DashMessaging Prototype' }} – Participant console</span>
    </div>
</nav>
{% endblock %}
{% block content %}
<div class="card">
    <div class="card-content">
        <p class="grey-text">{{ hint_text }}</p>
    </div>
</div>
<div class="row">
    <div class="col s12 m8">
        <div class="card">
            <div class="card-content" style="min-height: 320px;">
                <h6>Message thread</h6>
                <div id="message-list" class="collection" style="max-height: 360px; overflow-y: auto;">
                    <!-- messages appended here -->
                </div>
            </div>
            <div class="card-action">
                <form id="send-form" class="row" style="margin-bottom: 0;">
                    <div class="input-field col s10">
                        <input id="message-input" type="text" placeholder="{{ input_placeholder or 'Type message...' }}" autocomplete="off">
                    </div>
                    <div class="col s2">
                        <button type="submit" class="btn primary waves-effect waves-light">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col s12 m4">
        <div class="card">
            <div class="card-content">
                <h6>Node flow</h6>
                <p class="grey-text" style="font-size: 0.85rem;">
                    Visualizes which node of the protocol has been executed.
                </p>
                <ul id="node-flow" class="collection" style="max-height: 360px; overflow-y: auto;">
                    <!-- node flow items -->
                </ul>
            </div>
        </div>
    </div>
</div>
<div id="participant-id" data-id="{{ participant_id }}" style="display: none;"></div>
{% endblock %}
{% block scripts %}
<script>
(function() {
    const participantId = document.getElementById('participant-id').getAttribute('data-id');
    const listEl = document.getElementById('message-list');
    const flowEl = document.getElementById('node-flow');
    const form = document.getElementById('send-form');
    const input = document.getElementById('message-input');

    function renderMessage(m) {
        const isOut = m.direction === 'OUTBOUND';
        const div = document.createElement('div');
        div.className = 'collection-item ' + (isOut ? 'blue lighten-5' : 'grey lighten-4');
        div.style.borderLeft = '4px solid ' + (isOut ? '#1976d2' : '#757575');
        const time = m.created_at ? new Date(m.created_at).toLocaleTimeString() : '';
        div.innerHTML = '<strong>' + (isOut ? 'Bot' : 'You') + '</strong> ' + (m.text || '') + ' <span class="grey-text right">' + time + '</span>';
        listEl.appendChild(div);
        listEl.scrollTop = listEl.scrollHeight;
    }

    function renderFlowItem(item, isLast) {
        const li = document.createElement('li');
        li.className = 'collection-item ' + (isLast ? 'blue lighten-5' : '');
        const time = item.executed_at ? new Date(item.executed_at).toLocaleTimeString() : '';
        li.innerHTML =
            '<div style="display:flex;justify-content:space-between;align-items:center;">' +
            '<div>' +
            '<span class="grey-text text-darken-2"><strong>' + item.node_name + '</strong></span><br>' +
            '<span class="grey-text" style="font-size:0.8rem;">' + item.template_name + '</span>' +
            '</div>' +
            '<span class="grey-text" style="font-size:0.75rem;">' + time + '</span>' +
            '</div>';
        flowEl.appendChild(li);
    }

    function fetchMessagesAndFlow() {
        fetch('/api/participants/' + participantId + '/messages')
            .then(r => r.json())
            .then(messages => {
                listEl.innerHTML = '';
                messages.forEach(renderMessage);
                return fetch('/api/participants/' + participantId + '/timeline');
            })
            .then(r => r.json())
            .then(flow => {
                flowEl.innerHTML = '';
                const len = flow.length;
                flow.forEach(function (item, idx) {
                    renderFlowItem(item, idx === len - 1);
                });
            })
            .catch(() => {});
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const text = (input.value || '').trim();
        if (!text) return;
        input.value = '';
        fetch('/api/participants/' + participantId + '/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text })
        })
        .then(r => {
            if (!r.ok) return r.json().then(d => { throw new Error(d.detail || 'Send failed'); });
            return r.json();
        })
        .then(() => { fetchMessagesAndFlow(); })
        .catch(err => { M.toast({ html: err.message || 'Error', classes: 'red' }); });
    });

    fetchMessagesAndFlow();
    setInterval(fetchMessagesAndFlow, 2500);
})();
</script>
{% endblock %}
